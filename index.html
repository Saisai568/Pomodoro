<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZEN FOCUS | Cyberpunk Timer</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        :root {
            --neon-blue: #00f3ff;
            --neon-purple: #bc13fe;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-color: #e0e0e0;
        }

        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Share Tech Mono', monospace;
            background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e, #141E30);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: var(--text-color);
            overflow: hidden;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            text-align: center;
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            padding: 3rem 4rem;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            /* ÊîæÂ§ßÂÆπÂô®ÔºöË¶ñÁ™ó 90% ÊàñÊúÄÂ§ß 760px */
            width: min(90vw, 760px);
            max-width: 760px;
            position: relative;
            z-index: 10;
        }

        .container::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(45deg, var(--neon-blue), transparent, var(--neon-purple));
            z-index: -1;
            border-radius: 22px;
            opacity: 0.3;
        }

        h1 {
            font-size: 1.4rem;
            letter-spacing: 4px;
            margin-bottom: 2rem;
            text-transform: uppercase;
            color: rgba(255,255,255,0.7);
        }

        .timer-display {
            font-size: 6.5rem;
            margin: 1.5rem 0;
            text-shadow: 0 0 20px rgba(0, 243, 255, 0.5);
            font-variant-numeric: tabular-nums;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
        }

        button {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            padding: 12px 24px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 1.05rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            flex: 1;
            text-transform: uppercase;
        }

        button:hover {
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 15px var(--neon-blue);
            border-color: var(--neon-blue);
            text-shadow: 0 0 5px var(--neon-blue);
        }

        button.reset:hover {
            box-shadow: 0 0 15px var(--neon-purple);
            border-color: var(--neon-purple);
            text-shadow: 0 0 5px var(--neon-purple);
        }

        .status {
            margin-top: 1rem;
            font-size: 0.8rem;
            opacity: 0.6;
            height: 1rem;
        }

        .total-time {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            opacity: 0.8;
            color: var(--text-color);
            letter-spacing: 1px;
        }

        /* Session Dots */
        .sessions {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 1.5rem;
            height: 12px;
        }

        .session-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .session-dot.active {
            background: var(--neon-blue);
            box-shadow: 0 0 10px var(--neon-blue), 0 0 20px var(--neon-blue);
        }

        /* Glitch Effect */
        .glitch {
            position: relative;
        }

        .glitch::before,
        .glitch::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--glass-bg);
        }

        .glitch::before {
            left: 2px;
            text-shadow: -1px 0 #ff00c1;
            clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim 5s infinite linear alternate-reverse;
        }

        .glitch::after {
            left: -2px;
            text-shadow: -1px 0 #00fff9;
            clip: rect(44px, 450px, 56px, 0);
            animation: glitch-anim2 5s infinite linear alternate-reverse;
        }

        @keyframes glitch-anim {
            0% { clip: rect(31px, 9999px, 94px, 0); }
            4.166666667% { clip: rect(91px, 9999px, 43px, 0); }
            8.333333333% { clip: rect(65px, 9999px, 59px, 0); }
            12.5% { clip: rect(98px, 9999px, 96px, 0); }
            16.66666667% { clip: rect(6px, 9999px, 3px, 0); }
            20.83333333% { clip: rect(43px, 9999px, 82px, 0); }
            25% { clip: rect(46px, 9999px, 14px, 0); }
            29.16666667% { clip: rect(93px, 9999px, 23px, 0); }
            33.33333333% { clip: rect(6px, 9999px, 66px, 0); }
            37.5% { clip: rect(2px, 9999px, 92px, 0); }
            41.66666667% { clip: rect(84px, 9999px, 10px, 0); }
            45.83333333% { clip: rect(53px, 9999px, 94px, 0); }
            50% { clip: rect(24px, 9999px, 8px, 0); }
            54.16666667% { clip: rect(68px, 9999px, 4px, 0); }
            58.33333333% { clip: rect(95px, 9999px, 38px, 0); }
            62.5% { clip: rect(46px, 9999px, 64px, 0); }
            66.66666667% { clip: rect(2px, 9999px, 2px, 0); }
            70.83333333% { clip: rect(74px, 9999px, 57px, 0); }
            75% { clip: rect(63px, 9999px, 84px, 0); }
            79.16666667% { clip: rect(35px, 9999px, 53px, 0); }
            83.33333333% { clip: rect(20px, 9999px, 40px, 0); }
            87.5% { clip: rect(7px, 9999px, 24px, 0); }
            91.66666667% { clip: rect(60px, 9999px, 18px, 0); }
            95.83333333% { clip: rect(37px, 9999px, 65px, 0); }
            100% { clip: rect(67px, 9999px, 88px, 0); }
        }

        @keyframes glitch-anim2 {
            0% { clip: rect(65px, 9999px, 100px, 0); }
            100% { clip: rect(10px, 9999px, 85px, 0); }
        }

        /* Theme Selection */
        .theme-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            width: 30px;
            height: 30px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            border: 1px solid var(--glass-border);
            background: rgba(0,0,0,0.2);
            z-index: 20;
            cursor: pointer;
            color: var(--text-color);
            line-height: 0;
        }
        
        .theme-btn:hover {
            background: var(--neon-blue);
            color: #000;
            box-shadow: 0 0 10px var(--neon-blue);
        }

        .theme-menu {
            position: absolute;
            top: 50px;
            left: 15px;
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 10px;
            display: none;
            flex-direction: column;
            gap: 8px;
            z-index: 21;
        }

        .theme-menu.show {
            display: flex;
        }

        .theme-option {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.3);
            transition: transform 0.2s;
        }

        .theme-option:hover {
            transform: scale(1.2);
            border-color: #fff;
        }

        /* Lofi Mode */
        .mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--neon-blue);
            padding: 8px 16px;
            font-size: 0.8rem;
            width: auto;
            flex: none;
        }
        
        .mode-toggle.active {
            background: var(--neon-blue);
            color: #000;
            box-shadow: 0 0 15px var(--neon-blue);
            text-shadow: none;
        }

        .video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
            opacity: 0;
            transition: opacity 1s ease;
            pointer-events: none;
        }

        .video-container.active {
            opacity: 1;
        }

        .video-container iframe {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100vw;
            height: 56.25vw; /* 16:9 aspect ratio */
            min-height: 100vh;
            min-width: 177.77vh; /* 16:9 aspect ratio */
            transform: translate(-50%, -50%) scale(1.2);
            pointer-events: none; /* Prevent interaction */
        }

        /* Minimize Feature */
        .window-control {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            border: 1px solid var(--glass-border);
            background: rgba(0,0,0,0.2);
            z-index: 20;
            flex: none;
            line-height: 0;
        }

        .window-control:hover {
            background: var(--neon-blue);
            color: #000;
            box-shadow: 0 0 10px var(--neon-blue);
        }

        .container.minimized {
            position: fixed;
            bottom: 40px;
            right: 40px;
            width: auto;
            min-width: auto;
            padding: 1.5rem 2rem;
            margin: 0;
            /* Override flex centering from body */
            top: auto;
            left: auto;
            transform: none;
        }

        .container.minimized h1,
        .container.minimized .controls,
        .container.minimized .status,
        .container.minimized .sessions {
            display: none !important;
        }

        .container.minimized .timer-display {
            font-size: 3rem;
            margin: 0;
        }

        /* Study Room Panel */
        .room-panel {
            position: fixed;
            left: -350px;
            top: 20%;
            width: 350px;
            box-sizing: border-box;
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-left: none;
            border-radius: 0 20px 20px 0;
            padding: 1.5rem;
            transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 90;
            display: flex;
            flex-direction: column;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.2);
        }

        .room-panel.open {
            left: 0;
        }

        .room-tab {
            position: absolute;
            right: -40px;
            top: 20px;
            width: 40px;
            height: 40px;
            background: var(--neon-purple);
            border-radius: 0 10px 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 2px 0 10px rgba(188, 19, 254, 0.3);
            color: #fff;
        }

        .room-content h3 {
            margin: 0 0 1rem 0;
            color: var(--neon-purple);
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .user-list {
            margin-top: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 0.9rem;
        }

        .user-status {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .status-focus { background: rgba(0, 243, 255, 0.2); color: var(--neon-blue); }
        .status-break { background: rgba(188, 19, 254, 0.2); color: var(--neon-purple); }
        .status-ready { background: rgba(255, 255, 255, 0.1); color: #aaa; }

        .room-code-display {
            font-size: 1.2rem;
            color: var(--neon-blue);
            margin: 10px 0;
            font-weight: bold;
            letter-spacing: 2px;
            text-align: center;
            border: 1px dashed var(--glass-border);
            padding: 5px;
        }

        /* Water Reminder Panel */
        .water-panel {
            position: fixed;
            right: -220px; /* Hide content, show tab */
            top: 20%;
            width: 220px;
            box-sizing: border-box;
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-right: none;
            border-radius: 20px 0 0 20px;
            padding: 1.5rem;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 90;
            display: flex;
            flex-direction: column;
            box-shadow: -5px 5px 15px rgba(0,0,0,0.2);
        }

        .water-panel:hover {
            right: 0;
        }

        .water-tab {
            position: absolute;
            left: -40px;
            top: 20px;
            width: 40px;
            height: 40px;
            background: var(--neon-blue);
            border-radius: 10px 0 0 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: -2px 0 10px rgba(0, 243, 255, 0.3);
            color: #000;
        }

        .water-content {
            width: 100%;
            text-align: left;
        }

        .water-content h3 {
            margin: 0 0 1rem 0;
            color: var(--neon-blue);
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            font-size: 0.8rem;
            margin-bottom: 0.3rem;
            color: #aaa;
        }

        .input-group input {
            width: 100%;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            padding: 8px;
            border-radius: 4px;
            font-family: 'Share Tech Mono', monospace;
            box-sizing: border-box;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: var(--neon-blue);
        }

        .water-status {
            margin-top: 1rem;
            font-size: 0.9rem;
            color: var(--neon-purple);
            font-weight: bold;
        }

    </style>
</head>
<body>

    <div class="video-container" id="lofiBg">
        <iframe id="lofiVideo" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
    </div>

    <button id="lofiBtn" class="mode-toggle" onclick="toggleLofiMode()">Lofi Mode: OFF</button>

    <div class="room-panel" id="roomPanel">
        <div class="room-tab" onclick="toggleRoomPanel()">
            <span>üåê</span>
        </div>
        <div class="room-content" id="roomLobby">
            <h3>Study Room</h3>
            <div class="input-group">
                <label>Username</label>
                <input type="text" id="usernameInput" placeholder="Enter name">
            </div>
            <button onclick="createRoom()" style="margin-bottom: 10px;">Create Room</button>
            <div class="input-group">
                <label>Room Code</label>
                <input type="text" id="roomCodeInput" placeholder="6-CHAR CODE" style="text-transform: uppercase;">
            </div>
            <button onclick="joinRoom()">Join Room</button>
        </div>

        <div class="room-content" id="roomView" style="display: none;">
            <h3>Live Room</h3>
            <div class="room-code-display" id="currentRoomCode">------</div>
            <div style="text-align: right; margin-bottom: 5px;">
                <button onclick="refreshUserList()" style="padding: 2px 8px; font-size: 0.7rem; width: auto; border-radius: 4px;">‚Üª Sync</button>
            </div>
            <div class="user-list" id="userList">
                <!-- Users will be listed here -->
            </div>
            <button onclick="leaveRoom()" style="margin-top: 10px; background: rgba(255,0,0,0.2); border-color: rgba(255,0,0,0.5);">Leave Room</button>
        </div>
    </div>

    <div class="water-panel">
        <div class="water-tab">
            <span>üíß</span>
        </div>
        <div class="water-content">
            <h3>Hydration</h3>
            <div class="input-group">
                <label>Interval (mins)</label>
                <input type="number" id="waterInterval" value="30" min="1">
            </div>
            <div class="input-group">
                <label>Amount (ml)</label>
                <input type="number" id="waterAmount" value="200" min="50">
            </div>
            <button onclick="setWaterReminder()">Set Reminder</button>
            <div class="water-status" id="waterStatus">Next sip: --:--</div>
        </div>
    </div>

    <div class="container">
        <button id="minimizeBtn" class="window-control" onclick="toggleMinimize()" style="display: none;">‚àí</button>
        
        <!-- Theme Button -->
        <button class="theme-btn" onclick="toggleThemeMenu()" title="Change Theme">üé®</button>
        <div class="theme-menu" id="themeMenu">
            <!-- Options generated by JS -->
        </div>

        <h1>Focus Mode</h1>
        <div class="sessions" id="sessions">
            <!-- Dots will be added here -->
        </div>
        <div class="timer-display" id="timer" data-text="25:00">25:00</div>
        
        <div class="controls">
            <button id="startBtn" onclick="startTimer()">Start</button>
            <button id="pauseBtn" onclick="pauseTimer()">Pause</button>
            <button id="nextBtn" onclick="nextSession()" style="display: none;">Next</button>
            <button class="reset" onclick="resetTimer()">Reset</button>
        </div>
        <div class="status" id="statusText">READY</div>
        <div class="total-time" id="totalTime">Total Focus: 0s</div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let timeLeft = 25 * 60; // 25 minutes in seconds
        let timerId = null;
        let isWorkTime = true;
        let completedSessions = 0;
        let totalFocusTime = 0;
        const timerDisplay = document.getElementById('timer');
        const statusText = document.getElementById('statusText');
        const totalTimeDisplay = document.getElementById('totalTime');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const nextBtn = document.getElementById('nextBtn');
        const sessionsContainer = document.getElementById('sessions');

        // Audio Context
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playTone(freq, type, duration, vol = 0.1) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function playClick() {
            playTone(1200, 'sine', 0.05, 0.05);
        }

        function playStart() {
            playTone(440, 'sine', 0.1);
            setTimeout(() => playTone(880, 'square', 0.3, 0.05), 100);
        }

        function playAlarm() {
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(440, now);
            osc.frequency.linearRampToValueAtTime(880, now + 0.5);
            osc.frequency.linearRampToValueAtTime(440, now + 1.0);
            
            gain.gain.setValueAtTime(0.2, now);
            gain.gain.linearRampToValueAtTime(0, now + 1.0);
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(now + 1.0);
        }

        function updateSessions() {
            sessionsContainer.innerHTML = '';
            // Show up to 4 dots, then maybe reset or just keep adding? Let's show 4 max for design
            for (let i = 0; i < 4; i++) {
                const dot = document.createElement('div');
                dot.className = 'session-dot';
                if (i < completedSessions % 5) { // Cycle every 4 sessions (actually 5th is long break usually, but let's keep simple)
                     if (i < completedSessions) dot.classList.add('active');
                }
                sessionsContainer.appendChild(dot);
            }
        }

        function updateTotalTimeDisplay() {
            const hours = Math.floor(totalFocusTime / 3600);
            const minutes = Math.floor((totalFocusTime % 3600) / 60);
            const seconds = totalFocusTime % 60;
            
            let timeString = "Total Focus: ";
            if (hours > 0) timeString += `${hours}h `;
            if (minutes > 0) timeString += `${minutes}m `;
            timeString += `${seconds}s`;
            
            totalTimeDisplay.textContent = timeString;
        }

        function updateDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const displayString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            timerDisplay.textContent = displayString;
            timerDisplay.setAttribute('data-text', displayString); // For glitch effect
            document.title = `${displayString} - Zen Focus`;
            
            // Random glitch effect when running
            if (timerId && Math.random() > 0.95) {
                timerDisplay.classList.add('glitch');
                setTimeout(() => timerDisplay.classList.remove('glitch'), 200);
            }
        }

        // Theme Logic
        const themes = [
            {
                name: 'Cyberpunk',
                work: 'linear-gradient(-45deg, #0f0c29, #302b63, #24243e, #141E30)',
                break: 'linear-gradient(-45deg, #134e5e, #71b280, #2c5364, #203a43)',
                blue: '#00f3ff',
                purple: '#bc13fe'
            },
            {
                name: 'Sunset',
                work: 'linear-gradient(-45deg, #355C7D, #6C5B7B, #C06C84)',
                break: 'linear-gradient(-45deg, #FFB75E, #ED8F03)',
                blue: '#FFC371',
                purple: '#FF5F6D'
            },
            {
                name: 'Ocean',
                work: 'linear-gradient(-45deg, #1A2980, #26D0CE)',
                break: 'linear-gradient(-45deg, #4CA1AF, #C4E0E5)',
                blue: '#4FACFE',
                purple: '#00F260'
            },
            {
                name: 'Forest',
                work: 'linear-gradient(-45deg, #134E5E, #71B280)',
                break: 'linear-gradient(-45deg, #56ab2f, #a8e063)',
                blue: '#a8e063',
                purple: '#56ab2f'
            }
        ];
        
        let currentThemeIndex = 0;

        function toggleThemeMenu() {
            document.getElementById('themeMenu').classList.toggle('show');
        }

        function selectTheme(index) {
            currentThemeIndex = index;
            updateTheme();
            toggleThemeMenu();
        }

        function updateTheme() {
            const root = document.documentElement;
            const theme = themes[currentThemeIndex];
            
            if (isWorkTime) {
                root.style.setProperty('--neon-blue', theme.blue);
                root.style.setProperty('--neon-purple', theme.purple);
                document.body.style.backgroundImage = theme.work;
            } else {
                root.style.setProperty('--neon-blue', theme.blue);
                root.style.setProperty('--neon-purple', theme.purple);
                document.body.style.backgroundImage = theme.break;
            }
        }

        // Initialize theme menu
        function initThemeMenu() {
            const themeMenu = document.getElementById('themeMenu');
            themes.forEach((theme, index) => {
                const btn = document.createElement('div');
                btn.className = 'theme-option';
                btn.style.background = theme.work;
                btn.title = theme.name;
                btn.onclick = () => selectTheme(index);
                themeMenu.appendChild(btn);
            });
        }
        
        // Call init
        setTimeout(initThemeMenu, 0);

        function startTimer() {
            if (timerId) return;
            playStart();
            
            startBtn.style.display = "none";
            pauseBtn.style.display = "inline-block";
            nextBtn.style.display = "inline-block";
            updateTheme();

            if (isWorkTime) {
                statusText.textContent = "FOCUSING...";
            } else {
                statusText.textContent = "BREAK TIME";
            }
            statusText.style.color = "var(--neon-blue)";
            
            timerId = setInterval(() => {
                timeLeft--;
                updateDisplay();

                if (isWorkTime) {
                    totalFocusTime++;
                    updateTotalTimeDisplay();
                }

                if (timeLeft <= 0) {
                    clearInterval(timerId);
                    timerId = null;
                    
                    if (isWorkTime) {
                        completedSessions++;
                        updateSessions();
                    }

                    statusText.textContent = "SESSION COMPLETE";
                    statusText.style.color = "var(--neon-purple)";
                    playAlarm();
                    flashScreen();
                    alert("Time is up!");
                }
            }, 1000);
        }

        function pauseTimer() {
            playClick();
            clearInterval(timerId);
            timerId = null;
            startBtn.style.display = "inline-block";
            pauseBtn.style.display = "none";
            statusText.textContent = "PAUSED";
            statusText.style.color = "#e0e0e0";
            timerDisplay.classList.add('glitch'); // Glitch on pause
        }

        function resetTimer() {
            playClick();
            pauseTimer();
            isWorkTime = true;
            updateTheme();
            timeLeft = 25 * 60;
            completedSessions = 0;
            updateSessions();
            updateDisplay();
            statusText.textContent = "READY";
            statusText.style.color = "#e0e0e0";
            document.title = "ZEN FOCUS | Cyberpunk Timer";
            nextBtn.style.display = "none";
            timerDisplay.classList.remove('glitch');
        }

        function nextSession() {
            playClick();
            const nextMode = isWorkTime ? "Break" : "Focus";
            if (!confirm(`Ready to switch to ${nextMode} mode?`)) return;

            clearInterval(timerId);
            timerId = null;
            
            // If skipping work, do we count it? Maybe not.
            // But if skipping break, we just go to work.
            
            isWorkTime = !isWorkTime;
            
            if (isWorkTime) {
                timeLeft = 25 * 60;
            } else {
                timeLeft = 5 * 60;
            }
            updateDisplay();
            startTimer();
        }

        function flashScreen() {
            document.body.style.background = "var(--neon-purple)";
            setTimeout(() => {
                document.body.style.background = "";
                updateTheme(); // Restore theme background
            }, 500);
        }

        function toggleMinimize() {
            const container = document.querySelector('.container');
            const btn = document.getElementById('minimizeBtn');
            container.classList.toggle('minimized');
            
            if (container.classList.contains('minimized')) {
                btn.textContent = '+';
            } else {
                btn.textContent = '‚àí';
            }
        }

        function toggleRoomPanel() {
            document.getElementById('roomPanel').classList.toggle('open');
        }

        let isLofiMode = false;
        function toggleLofiMode() {
            isLofiMode = !isLofiMode;
            const bg = document.getElementById('lofiBg');
            const video = document.getElementById('lofiVideo');
            const btn = document.getElementById('lofiBtn');
            const minBtn = document.getElementById('minimizeBtn');
            
            if (isLofiMode) {
                // Lofi Girl live stream ID: jfKfPfyJRdk
                const videoId = "jfKfPfyJRdk";
                video.src = `https://www.youtube-nocookie.com/embed/${videoId}?autoplay=1&mute=1&controls=0&showinfo=0&loop=1&playlist=${videoId}&version=3&enablejsapi=1`; 
                bg.classList.add('active');
                btn.textContent = "Lofi Mode: ON";
                btn.classList.add('active');
                // Clear background to ensure video is visible
                document.body.style.background = 'black';
                minBtn.style.display = 'flex';
            } else {
                bg.classList.remove('active');
                setTimeout(() => { video.src = ""; }, 1000);
                btn.textContent = "Lofi Mode: OFF";
                btn.classList.remove('active');
                updateTheme(); // Restore theme background
                minBtn.style.display = 'none';
                
                // Auto restore if minimized
                const container = document.querySelector('.container');
                if (container.classList.contains('minimized')) {
                    toggleMinimize();
                }
            }
        }

        // Water Reminder Logic
        let waterTimerId = null;
        let waterTimeLeft = 0;
        
        function setWaterReminder() {
            const intervalInput = document.getElementById('waterInterval');
            const amountInput = document.getElementById('waterAmount');
            
            const minutes = parseInt(intervalInput.value);
            if (isNaN(minutes) || minutes < 1) {
                alert("Please enter a valid time interval.");
                return;
            }

            if (waterTimerId) clearInterval(waterTimerId);
            
            waterTimeLeft = minutes * 60;
            updateWaterStatus();
            playClick();
            
            waterTimerId = setInterval(() => {
                waterTimeLeft--;
                updateWaterStatus();
                
                if (waterTimeLeft <= 0) {
                    playAlarm(); // Reuse alarm sound
                    alert(`üíß Time to hydrate! Drink ${amountInput.value}ml of water.`);
                    waterTimeLeft = minutes * 60; // Auto restart cycle
                }
            }, 1000);
        }

        function updateWaterStatus() {
            const statusDisplay = document.getElementById('waterStatus');
            if (waterTimeLeft <= 0) {
                statusDisplay.textContent = "Next sip: --:--";
                return;
            }
            const m = Math.floor(waterTimeLeft / 60);
            const s = waterTimeLeft % 60;
            statusDisplay.textContent = `Next sip: ${m}:${s.toString().padStart(2, '0')}`;
        }

        // Initialize
        updateSessions();
        updateDisplay();
        pauseBtn.style.display = "none";

        // --- Multiplayer Logic ---
        const socket = io();
        let currentRoomId = null;
        let myUsername = "Guest";
        let isHost = false;

        function getStatusString() {
            if (!timerId && !currentRoomId) return 'READY'; // Local ready
            if (currentRoomId && !isWorkTime) return 'BREAK'; // Remote break
            if (currentRoomId && isWorkTime) return 'FOCUS'; // Remote focus
            return isWorkTime ? 'FOCUS' : 'BREAK';
        }

        function createRoom() {
            const name = document.getElementById('usernameInput').value.trim();
            if (!name) return alert("Please enter a username");
            myUsername = name;
            socket.emit('createRoom', name);
        }

        function joinRoom() {
            const name = document.getElementById('usernameInput').value.trim();
            const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            if (!name) return alert("Please enter a username");
            if (!code) return alert("Please enter a room code");
            myUsername = name;
            socket.emit('joinRoom', { roomId: code, username: name });
        }

        function leaveRoom() {
            socket.disconnect();
            socket.connect(); // Reconnect to get a fresh socket
            showLobby();
            currentRoomId = null;
            isHost = false;
            
            // Restore local timer state
            resetTimer();
            document.querySelector('.controls').style.display = 'flex'; // Show controls again
            startBtn.style.display = 'inline-block';
            pauseBtn.style.display = 'none';
            nextBtn.style.display = 'none';
        }

        function refreshUserList() {
            if (currentRoomId) {
                socket.emit('refreshUsers', currentRoomId);
            }
        }

        function showLobby() {
            document.getElementById('roomLobby').style.display = 'block';
            document.getElementById('roomView').style.display = 'none';
        }

        function showRoom(roomId, users, hostStatus) {
            document.getElementById('roomLobby').style.display = 'none';
            document.getElementById('roomView').style.display = 'block';
            document.getElementById('currentRoomCode').textContent = roomId;
            currentRoomId = roomId;
            isHost = hostStatus;
            updateUserList(users);
            
            // Stop local timer if running
            if (timerId) {
                clearInterval(timerId);
                timerId = null;
            }

            // Update UI controls based on host status
            updateRoomControls();
        }

        function updateRoomControls() {
            const controls = document.querySelector('.controls');
            if (isHost) {
                controls.style.display = 'flex';
                // Buttons will be managed by timer updates
            } else {
                // Hide controls for guests, they just watch
                controls.style.display = 'none';
            }
        }

        function updateUserList(users) {
            const list = document.getElementById('userList');
            list.innerHTML = '';
            users.forEach(user => {
                const div = document.createElement('div');
                div.className = 'user-item';
                
                let statusClass = 'status-ready';
                if (user.status === 'FOCUS') statusClass = 'status-focus';
                if (user.status === 'BREAK') statusClass = 'status-break';

                div.innerHTML = `
                    <span>${user.name} ${user.id === socket.id ? '(You)' : ''} ${user.id === users[0].id ? '‚ôï' : ''}</span>
                    <span class="user-status ${statusClass}">${user.status}</span>
                `;
                list.appendChild(div);
            });
        }

        // Socket Events
        socket.on('roomCreated', ({ roomId, users, isHost: hostStatus }) => {
            showRoom(roomId, users, hostStatus);
        });

        socket.on('roomJoined', ({ roomId, users, isHost: hostStatus, timerState }) => {
            showRoom(roomId, users, hostStatus);
            // Sync initial timer state
            if (timerState) {
                timeLeft = timerState.timeLeft;
                isWorkTime = timerState.isWorkTime;
                
                if (timerState.totalFocusTime !== undefined) {
                    totalFocusTime = timerState.totalFocusTime;
                    updateTotalTimeDisplay();
                }

                updateDisplay();
                updateTheme();
                
                if (timerState.isRunning) {
                    statusText.textContent = isWorkTime ? "FOCUSING..." : "BREAK TIME";
                    statusText.style.color = "var(--neon-blue)";
                } else {
                    statusText.textContent = "READY";
                    statusText.style.color = "#e0e0e0";
                }
            }
        });

        socket.on('timerUpdate', (state) => {
            timeLeft = state.timeLeft;
            isWorkTime = state.isWorkTime;
            
            if (state.totalFocusTime !== undefined) {
                totalFocusTime = state.totalFocusTime;
                updateTotalTimeDisplay();
            }

            // Auto-sync user list if count mismatch
            if (state.userCount !== undefined) {
                const currentCount = document.querySelectorAll('.user-item').length;
                if (state.userCount !== currentCount) {
                    console.log('User count mismatch, requesting sync...');
                    refreshUserList();
                }
            }

            updateDisplay();
            updateTheme();

            // Update Status Text
            if (state.isRunning) {
                statusText.textContent = isWorkTime ? "FOCUSING..." : "BREAK TIME";
                statusText.style.color = "var(--neon-blue)";
                
                // Update Buttons for Host
                if (isHost) {
                    startBtn.style.display = "none";
                    pauseBtn.style.display = "inline-block";
                    nextBtn.style.display = "inline-block";
                }
            } else {
                statusText.textContent = "PAUSED"; // Or READY
                statusText.style.color = "#e0e0e0";
                
                // Update Buttons for Host
                if (isHost) {
                    startBtn.style.display = "inline-block";
                    pauseBtn.style.display = "none";
                    nextBtn.style.display = "inline-block";
                }
            }
        });

        socket.on('timerEnded', ({ mode }) => {
            statusText.textContent = "SESSION COMPLETE";
            statusText.style.color = "var(--neon-purple)";
            playAlarm();
            flashScreen();
            alert(`Room Timer: ${mode} session complete!`);
            
            if (isHost) {
                startBtn.style.display = "inline-block";
                pauseBtn.style.display = "none";
            }
        });

        socket.on('userJoined', ({ users }) => {
            updateUserList(users);
        });

        socket.on('userLeft', ({ users }) => {
            updateUserList(users);
        });

        socket.on('statusUpdated', ({ users }) => {
            updateUserList(users);
        });

        socket.on('usersRefreshed', ({ users }) => {
            updateUserList(users);
        });

        socket.on('roomClosed', () => {
            alert("The host has left the room. The room is now closed.");
            leaveRoom();
        });

        socket.on('error', (msg) => {
            alert(msg);
        });

        // Hook into existing timer functions to update status
        const originalStartTimer = startTimer;
        startTimer = function() {
            if (currentRoomId) {
                if (isHost) socket.emit('hostAction', { roomId: currentRoomId, action: 'start' });
            } else {
                originalStartTimer();
            }
        };

        const originalPauseTimer = pauseTimer;
        pauseTimer = function() {
            if (currentRoomId) {
                if (isHost) socket.emit('hostAction', { roomId: currentRoomId, action: 'pause' });
            } else {
                originalPauseTimer();
            }
        };

        const originalResetTimer = resetTimer;
        resetTimer = function() {
            if (currentRoomId) {
                if (isHost) socket.emit('hostAction', { roomId: currentRoomId, action: 'reset' });
            } else {
                originalResetTimer();
            }
        };

        const originalNextSession = nextSession;
        nextSession = function() {
            if (currentRoomId) {
                if (isHost) {
                    const nextMode = isWorkTime ? "Break" : "Focus";
                    if (!confirm(`Switch room to ${nextMode} mode?`)) return;
                    socket.emit('hostAction', { roomId: currentRoomId, action: 'next' });
                }
            } else {
                originalNextSession();
            }
        };

    </script>
</body>
</html>